name: AutoUI Discussion Bot (Vue + AntV)

on:
  discussion:
    types: [created, labeled, edited]
  discussion_comment:
    types: [created, edited]

permissions:
  contents: write
  discussions: write

jobs:
  autoui:
    runs-on: ubuntu-latest

    # Only run when discussion has label "AutoUI"
    if: ${{ contains(toJson(github.event.discussion.labels.*.name), 'AutoUI') }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # ---------- sanity ----------
      - name: Verify templates exist
        shell: bash
        run: |
          set -euo pipefail
          test -f .github/templates/autoui/questions.json
          test -f .github/templates/autoui/reply.md
          test -f .github/templates/autoui/Landing.vue.template
          test -f .github/templates/autoui/StatsChart.vue.template
          echo "All templates present."

      # ---------- parse discussion ----------
      - name: Parse discussion for answers + decide next question
        id: decide
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");

            const cfg = JSON.parse(
              fs.readFileSync(".github/templates/autoui/questions.json", "utf8")
            );

            const discussion = context.payload.discussion;

            const q = `
              query($id: ID!) {
                node(id: $id) {
                  ... on Discussion {
                    body
                    comments(first: 50) {
                      nodes { body }
                    }
                  }
                }
              }`;

            const data = await github.graphql(q, { id: discussion.node_id });
            const node = data.node;

            const textBlob = [
              node.body || "",
              ...(node.comments.nodes || []).map(c => c.body || "")
            ].join("\n\n");

            // support BOTH key:value and key=value
            const answers = {};
            for (const item of cfg.questions) {
              const re = new RegExp(
                `(?:^|\\n)\\s*${item.key}\\s*(?:=|:)\\s*([^\\n]+)`,
                "i"
              );
              const m = textBlob.match(re);
              if (m && m[1]) answers[item.key] = m[1].trim();
            }

            const next = cfg.questions.find(q => !answers[q.key]);

            const status = cfg.questions.map(q => {
              return answers[q.key]
                ? `- \`${q.key}\`: ✅ ${answers[q.key]}`
                : `- \`${q.key}\`: ❌ (missing)`;
            }).join("\n");

            fs.writeFileSync(
              "/tmp/autoui-answers.json",
              JSON.stringify(answers, null, 2)
            );

            core.setOutput("complete", next ? "false" : "true");
            core.setOutput("next_question", next ? next.ask : "");
            core.setOutput("status_block", status);

      # ---------- reply ----------
      - name: Render reply comment
        if: ${{ steps.decide.outputs.complete == 'false' }}
        shell: bash
        run: |
          set -euo pipefail
          export STATUS_BLOCK="${{ steps.decide.outputs.status_block }}"
          export NEXT_QUESTION="${{ steps.decide.outputs.next_question }}"
          envsubst < .github/templates/autoui/reply.md > /tmp/autoui-reply.md
          cat /tmp/autoui-reply.md

      - name: Comment next question
        if: ${{ steps.decide.outputs.complete == 'false' }}
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require("fs");
            const body = fs.readFileSync("/tmp/autoui-reply.md", "utf8");

            await github.graphql(
              `mutation($id: ID!, $body: String!) {
                addDiscussionComment(input: { discussionId: $id, body: $body }) {
                  comment { id }
                }
              }`,
              { id: context.payload.discussion.node_id, body }
            );

      # ---------- codegen ----------
      - name: Setup Node
        if: ${{ steps.decide.outputs.complete == 'true' }}
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Generate Vue + AntV files
        if: ${{ steps.decide.outputs.complete == 'true' }}
        shell: bash
        run: |
          set -euo pipefail

          echo "Answers:"
          cat /tmp/autoui-answers.json

          PRODUCT_NAME="$(node -p "require('/tmp/autoui-answers.json').product_name")"
          OFFER_TYPE="$(node -p "require('/tmp/autoui-answers.json').offer_type")"
          DELIVERY_METHOD="$(node -p "require('/tmp/autoui-answers.json').delivery_method")"
          PLATFORMS="$(node -p "require('/tmp/autoui-answers.json').platforms")"
          PRICING_MODEL="$(node -p "require('/tmp/autoui-answers.json').pricing_model")"
          PRIMARY_CTA="$(node -p "require('/tmp/autoui-answers.json').primary_cta")"

          export PRODUCT_NAME OFFER_TYPE DELIVERY_METHOD PLATFORMS PRICING_MODEL PRIMARY_CTA

          mkdir -p coming-soon/src/components

          envsubst < .github/templates/autoui/Landing.vue.template > coming-soon/src/Landing.vue
          envsubst < .github/templates/autoui/StatsChart.vue.template > coming-soon/src/components/StatsChart.vue

          cat > coming-soon/src/App.vue <<'EOF'
import Landing from "./Landing.vue";
export default Landing;
EOF

          cd coming-soon
          if ! grep -q '"@antv/g2"' package.json; then
            npm install @antv/g2
          fi
          cd ..

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add coming-soon
          git commit -m "AutoUI: generate Vue landing + AntV chart" || true
          git push

      # ---------- done ----------
      - name: Comment completion
        if: ${{ steps.decide.outputs.complete == 'true' }}
        uses: actions/github-script@v7
        with:
          script: |
            const body =
`AutoUI complete ✅

Generated:
- coming-soon/src/Landing.vue
- coming-soon/src/components/StatsChart.vue
- updated App.vue

Pages deploy will publish on next run.`;

            await github.graphql(
              `mutation($id: ID!, $body: String!) {
                addDiscussionComment(input: { discussionId: $id, body: $body }) {
                  comment { id }
                }
              }`,
              { id: context.payload.discussion.node_id, body }
            );
